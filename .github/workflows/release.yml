name: release new version

on:
  push:
    branches:
      - test_branch

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: ⚙️ Generate SemVar
      id: gen_semvar
      uses: lukaszraczylo/semver-generator@PLACE_LATEST_TAG_HERE
      with:
        repository_local: true
    
    - name: 👊 Bump Version
      run: sed 's/.*static let version = .*/static let version = "${{ steps.gen_semvar.outputs.semantic_version }}"/' Sources/gen-ir/Versions.swift
    
    # Ensure a change has happened (so we don't re-release)
    - name: 🤫 Check for difference
      run: ! (git diff --quiet)

    # Commit the change
    - name: 💍 Commit
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git commit -am "gen-ir v${{steps.gen_semvar.outputs.semantic_version }}"
        git push

    # Tag the change
    - name: 🏷 Tag
    - run: |
        git tag -a "v${{ steps.gen_semvar.outputs.semantic_version }}" -m "gen-ir v${{ steps.gen_semvar.outputs.semantic_version }}"
        git push